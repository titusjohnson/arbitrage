<div class="travel">
  <h1 class="travel__title">Travel</h1>

  <%
    # Sort locations by distance from current location
    sorted_locations = @locations.sort_by { |loc| current_game.current_location.distance_to(loc) }
  %>

  <div class="locations-list">
    <% sorted_locations.each do |location| %>
      <%
        distance = current_game.current_location.distance_to(location)
        cost = distance <= 1 ? 0 : (distance - 1) * 100
        cost_label = cost == 0 ? "Free" : "$#{cost}"
        is_current_location = location.id == current_game.current_location_id
        has_buddy = @recently_visited_location_ids.include?(location.id)

        # Check if any active events affect this location
        location_has_event_effects = false
        current_game.game_events.active.includes(:event).each do |game_event|
          event = game_event.event
          if event.location_effects.present?
            location_tag_names = location.tags.map(&:name)
            ['price_modifiers', 'quantity_modifiers'].each do |modifier_type|
              next unless event.location_effects[modifier_type]
              event.location_effects[modifier_type].each do |modifier|
                if modifier['scoped_tags'] && modifier['scoped_tags']['location']
                  if (modifier['scoped_tags']['location'] & location_tag_names).any?
                    location_has_event_effects = true
                    break
                  end
                end
              end
              break if location_has_event_effects
            end
          end
          break if location_has_event_effects
        end
      %>
      <div class="location-card location-card--distance-<%= distance %> <%= 'location-card--current' if is_current_location %> <%= 'location-card--has-buddy' if has_buddy %> <%= 'location-card--has-events' if location_has_event_effects %>"
           data-controller="travel-confirmation <%= 'buddy-info' if has_buddy %>"
           data-travel-confirmation-from-value="<%= current_game.current_location.name %>"
           data-travel-confirmation-to-value="<%= location.name %>"
           data-travel-confirmation-cost-value="<%= cost %>"
           data-travel-confirmation-cost-label-value="<%= cost_label %>"
           <%= "data-buddy-info-location-id-value=\"#{location.id}\"" if has_buddy %>>
        <div class="location-card__header">
          <h2 class="location-card__name">
            <%= location.name %>
            <% if location_has_event_effects %>
              <span style="color: #ff6b35; margin-left: 0.25rem;" title="Active events affecting this location">‚ö°</span>
            <% end %>
          </h2>
          <div class="location-card__actions">
            <% if is_current_location %>
              <span class="location-card__current-label">You are here</span>
            <% else %>
              <%= button_to cost_label, travel_path,
                  params: { location_id: location.id },
                  method: :post,
                  title: "Travel. Advances Day",
                  class: "travel-button travel-button--distance-#{distance}",
                  data: {
                    distance: distance,
                    action: "click->travel-confirmation#confirm"
                  } %>
            <% end %>
            <% if has_buddy %>
              <button type="button"
                      class="info-button"
                      data-action="click->buddy-info#showModal"
                      data-buddy-info-location-id-param="<%= location.id %>"
                      title="Check location bonuses with your buddy">
                Info
              </button>
            <% end %>
          </div>
        </div>
        <% if location.description.present? %>
          <p class="location-card__description"><%= location.description %></p>
        <% end %>
        <% if location.tags.any? %>
          <details class="tags-toggle">
            <summary class="tags-toggle__summary">‚Ä¶</summary>
            <div class="tags">
              <% location.tags.each do |tag| %>
                <span class="tag tag--<%= tag.name.gsub('_', '-') %>"><%= tag.name.gsub('_', ' ') %></span>
              <% end %>
            </div>
          </details>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Pre-rendered Buddy Info Modals (hidden) -->
<div style="display: none;">
  <% @recently_visited_location_ids.each do |location_id| %>
    <% location = @locations.find { |l| l.id == location_id } %>
    <% next unless location %>

    <% game_resources = current_game.game_resources
                                    .includes(:resource)
                                    .order('resources.name')
                                    .limit(20) %>

    <div id="buddy-modal-<%= location.id %>" class="modal__template">
      <div class="modal__content">
        <div class="modal__header">
          <h2 class="modal__title">Market Info for <%= location.name %></h2>
          <button class="modal__close" aria-label="Close">&times;</button>
        </div>
        <div class="modal__body">
          <p class="modal__subtitle">Your buddy reports these prices (with location bonuses):</p>
          <% if game_resources.any? %>
            <table class="prices-table">
              <thead>
                <tr>
                  <th>Resource</th>
                  <th>Price</th>
                  <th>Available</th>
                </tr>
              </thead>
              <tbody>
                <% game_resources.each do |gr| %>
                  <%
                    # Calculate event effects for this resource at this location
                    gr_event_effects = EventEffectsService.new(current_game, gr, location: location).call
                    gr_has_price_effect = gr_event_effects[:price_multiplier] != 1.0
                    effective_price = (gr.current_price * gr_event_effects[:price_multiplier]).round(2)
                  %>
                  <tr>
                    <td class="prices-table__name"><%= gr.resource.name %></td>
                    <td class="prices-table__price">
                      $<%= number_with_precision(effective_price, precision: 2) %>
                      <% if gr_has_price_effect %>
                        ‚ö°
                      <% elsif gr.price_direction > 0.1 %>
                        üìà
                      <% elsif gr.price_direction < -0.1 %>
                        üìâ
                      <% else %>
                        ‚û°Ô∏è
                      <% end %>
                    </td>
                    <td class="prices-table__available"><%= gr.available_quantity %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="modal__empty">No prices available yet.</p>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
