<%
  resource = location_resource.resource
  inventory_items = inventory_by_resource[resource.id] || []
  has_inventory = inventory_items.any?

  if has_inventory
    # Calculate average purchase price and total quantity
    total_quantity = inventory_items.sum(&:quantity)
    total_cost = inventory_items.sum { |item| item.purchase_price * item.quantity }
    avg_purchase_price = total_cost / total_quantity

    # Calculate profit/loss
    current_value = location_resource.current_price * total_quantity
    total_paid = total_cost
    profit_loss = current_value - total_paid
    profit_loss_pct = ((profit_loss / total_paid) * 100).round(1)
    is_profit = profit_loss >= 0
  end

  # Calculate event effects
  event_effects = EventEffectsService.new(game, location_resource).call
  has_price_effect = event_effects[:price_multiplier] != 1.0
  has_availability_effect = event_effects[:availability_multiplier] != 1.0

  if has_price_effect
    # Calculate what the price would be without events
    base_price_without_events = (location_resource.current_price / event_effects[:price_multiplier]).round(2)
  end
%>
<tr id="resource_<%= location_resource.id %>">
  <td>
    <strong><%= resource.name %></strong>
    <% if resource.description.present? %>
      <br>
      <small class="Text--muted"><%= resource.description %></small>
    <% end %>
    <% if resource.tags.any? %>
      <details class="tags-toggle">
        <summary class="tags-toggle__summary">…</summary>
        <div class="tags">
          <% resource.tags.each do |tag| %>
            <span class="tag tag--<%= tag.name.gsub('_', '-') %>"><%= tag.name.gsub('_', ' ') %></span>
          <% end %>
        </div>
      </details>
    <% end %>
  </td>
  <td class="Table__Cell--right">
    <strong>$<%= number_with_delimiter(location_resource.current_price, delimiter: ',') %></strong>
    <% if has_price_effect %>
      <br>
      <small class="<%= event_effects[:price_multiplier] > 1.0 ? 'Text--danger' : 'Text--success' %>">
        <% if event_effects[:price_multiplier] > 1.0 %>
          ↑ +<%= ((event_effects[:price_multiplier] - 1.0) * 100).round(0) %>% event price
        <% else %>
          ↓ -<%= ((1.0 - event_effects[:price_multiplier]) * 100).round(0) %>% event price
        <% end %>
      </small>
    <% end %>
    <br>
    <small class="Text--muted">
      Size: <%= resource.inventory_size %>
      | <%= resource.rarity.titleize %>
      <br>
      Stock: <%= location_resource.available_quantity %><% if has_availability_effect %> (<%= event_effects[:availability_multiplier] > 1.0 ? '+' : '' %><%= ((event_effects[:availability_multiplier] - 1.0) * 100).round(0) %>%)<% end %>
    </small>
  </td>
  <td class="Table__Cell--right">
    <% if has_inventory %>
      <strong><%= total_quantity %> units</strong>
      <br>
      <small class="Text--muted">
        Avg: $<%= number_with_delimiter(avg_purchase_price.round(2), delimiter: ',') %>
      </small>
      <br>
      <small class="<%= is_profit ? 'Text--success' : 'Text--danger' %>">
        <%= is_profit ? '+' : '' %>$<%= number_with_delimiter(profit_loss.round(2), delimiter: ',') %>
        (<%= is_profit ? '+' : '' %><%= profit_loss_pct %>%)
      </small>
    <% else %>
      <small class="Text--muted">—</small>
    <% end %>
  </td>
  <td class="Table__Cell--right">
    <%= form_with url: marketplace_buy_path, method: :post, style: "display: inline;" do |form| %>
      <%= form.hidden_field :location_resource_id, value: location_resource.id %>
      <%= form.hidden_field :quantity, value: 1 %>
      <%= form.submit "Buy", class: "button button--primary" %>
    <% end %>
    <% if has_inventory %>
      <%= form_with url: marketplace_sell_path, method: :post, style: "display: inline;" do |form| %>
        <%= form.hidden_field :location_resource_id, value: location_resource.id %>
        <%= form.hidden_field :quantity, value: 1 %>
        <%= form.submit "Sell", class: "button" %>
      <% end %>
    <% end %>
  </td>
</tr>
