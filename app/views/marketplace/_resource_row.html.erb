<%
  resource = game_resource.resource
  inventory_items = inventory_by_resource[resource.id] || []
  has_inventory = inventory_items.any?

  if has_inventory
    # Calculate average purchase price and total quantity
    total_quantity = inventory_items.sum(&:quantity)
    total_cost = inventory_items.sum { |item| item.purchase_price * item.quantity }
    avg_purchase_price = total_cost / total_quantity

    # Calculate profit/loss
    current_value = game_resource.current_price * total_quantity
    total_paid = total_cost
    profit_loss = current_value - total_paid
    profit_loss_pct = ((profit_loss / total_paid) * 100).round(1)
    is_profit = profit_loss >= 0
  end

  # Calculate event effects (with location for location-specific bonuses)
  event_effects = EventEffectsService.new(game, game_resource, location: location).call
  has_price_effect = event_effects[:price_multiplier] != 1.0
  has_availability_effect = event_effects[:availability_multiplier] != 1.0

  if has_price_effect
    # Calculate what the price would be without events
    base_price_without_events = (game_resource.current_price / event_effects[:price_multiplier]).round(2)
  end

  # Calculate price change from previous day
  # The price_histories table stores historical/simulated prices for days 1-30
  # When the game advances days, new prices are recorded
  # On day 1, compare to the pre-generated history for day 1 (baseline)
  # On day 2+, compare to the previous day's recorded price
  current_day = game.current_day
  current_price = game_resource.current_price

  if current_day > 1
    previous_price = game_resource.price_on_day(current_day - 1)
  else
    # On day 1, compare current price to the initial historical day 1 price
    previous_price = game_resource.price_on_day(1)
  end

  if previous_price && previous_price > 0 && current_day > 1
    price_change = current_price - previous_price
    price_change_pct = ((price_change / previous_price) * 100).round(1)
  else
    price_change = 0
    price_change_pct = 0
  end

  # Determine trend based on last 3 days
  price_history = game_resource.price_history_array(days: 30).compact
  if price_history.size >= 3
    recent_prices = price_history.last(3)
    trend = if recent_prices[2] > recent_prices[1] && recent_prices[1] > recent_prices[0]
              :rising
            elsif recent_prices[2] < recent_prices[1] && recent_prices[1] < recent_prices[0]
              :falling
            else
              :stable
            end
  else
    trend = :stable
  end

  trend_icon = case trend
               when :rising then "↗"
               when :falling then "↘"
               else "→"
               end

  trend_color = case trend
                when :rising then "success"
                when :falling then "danger"
                else "muted"
                end
%>
<tr id="resource_<%= game_resource.id %>">
  <td>
    <strong><%= resource.name %></strong>
    <% if resource.description.present? %>
      <br>
      <small class="Text--muted"><%= resource.description %></small>
    <% end %>
    <br>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <small class="Text--muted">
        Size: <%= resource.inventory_size %>
        | <%= resource.rarity.titleize %>
        | Stock: <%= game_resource.available_quantity %><% if has_availability_effect %> (<%= event_effects[:availability_multiplier] > 1.0 ? '+' : '' %><%= ((event_effects[:availability_multiplier] - 1.0) * 100).round(0) %>%)<% end %>
      </small>
      <% if resource.tags.any? %>
        <details class="tags-toggle">
          <summary class="tags-toggle__summary">…</summary>
          <div class="tags">
            <% resource.tags.each do |tag| %>
              <span class="tag tag--<%= tag.name.gsub('_', '-') %>"><%= tag.name.gsub('_', ' ') %></span>
            <% end %>
          </div>
        </details>
      <% end %>
    </div>
  </td>
  <td class="Table__Cell--right">
    <div class="price-with-sparkline">
      <span class="sparkline sparkline--price">
        <%= peity_line_chart(
          game_resource.price_history_array(days: 30).compact,
          options: {
            width: 60,
            height: 20,
            stroke: "#0066cc",
            strokeWidth: 1.5,
            fill: "rgba(0, 102, 204, 0.1)"
          }
        ) %>
      </span>
      <div>
        <strong>$<%= number_with_delimiter(game_resource.current_price, delimiter: ',') %></strong>
        <span class="Text--<%= trend_color %>">
          <%= trend_icon %>
          <% if price_change != 0 %>
            <%= price_change > 0 ? '+' : '' %>$<%= number_with_delimiter(price_change.abs.round(2), delimiter: ',') %>
            (<%= price_change_pct > 0 ? '+' : '' %><%= price_change_pct %>%)
          <% end %>
        </span>
      </div>
    </div>
    <% if has_price_effect %>
      <br>
      <small class="<%= event_effects[:price_multiplier] > 1.0 ? 'Text--danger' : 'Text--success' %>">
        <% if event_effects[:price_multiplier] > 1.0 %>
          ↑ +<%= ((event_effects[:price_multiplier] - 1.0) * 100).round(0) %>% event price
        <% else %>
          ↓ -<%= ((1.0 - event_effects[:price_multiplier]) * 100).round(0) %>% event price
        <% end %>
      </small>
    <% end %>
  </td>
  <td class="Table__Cell--right">
    <% if has_inventory %>
      <strong><%= total_quantity %> units</strong>
      <br>
      <small class="Text--muted">
        Avg: $<%= number_with_delimiter(avg_purchase_price.round(2), delimiter: ',') %>
      </small>
      <br>
      <small class="<%= is_profit ? 'Text--success' : 'Text--danger' %>">
        <%= is_profit ? '+' : '' %>$<%= number_with_delimiter(profit_loss.round(2), delimiter: ',') %>
        (<%= is_profit ? '+' : '' %><%= profit_loss_pct %>%)
      </small>
    <% else %>
      <small class="Text--muted">—</small>
    <% end %>
  </td>
  <td class="Table__Cell--right">
    <%= form_with url: marketplace_buy_path, method: :post, style: "display: inline;" do |form| %>
      <%= form.hidden_field :game_resource_id, value: game_resource.id %>
      <%= form.hidden_field :quantity, value: 1 %>
      <%= form.submit "Buy", class: "button button--primary" %>
    <% end %>
    <% if has_inventory %>
      <%= form_with url: marketplace_sell_path, method: :post, style: "display: inline;" do |form| %>
        <%= form.hidden_field :game_resource_id, value: game_resource.id %>
        <%= form.hidden_field :quantity, value: 1 %>
        <%= form.submit "Sell", class: "button" %>
      <% end %>
    <% end %>
  </td>
</tr>
