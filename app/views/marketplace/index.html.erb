<div class="Page">
  <div class="Page__Header">
    <h1 class="Page__Title"><%= @location.name %> Marketplace</h1>
    <% if @location.description.present? %>
      <p class="Page__Subtitle"><%= @location.description %></p>
    <% end %>
  </div>

  <% @active_events = @game.game_events.active.includes(:event) %>
  <% @active_events.each do |game_event| %>
    <% event = game_event.event %>
    <% is_unseen = !game_event.seen? %>
    <% game_event.update(seen: true) if is_unseen %>
    <%
      # Create sanitized filename from event name
      svg_filename = event.name.downcase.gsub(/[^a-z0-9]+/, '_').gsub(/^_|_$/, '')
      svg_partial_path = "events/_graphics/#{svg_filename}"

      # Extract affected tags from resource_effects
      affected_tags = []
      if event.resource_effects.present?
        if event.resource_effects['price_modifiers']
          event.resource_effects['price_modifiers'].each do |mod|
            affected_tags.concat(mod['tags'] || [])
          end
        end
        if event.resource_effects['availability_modifiers']
          event.resource_effects['availability_modifiers'].each do |mod|
            affected_tags.concat(mod['tags'] || [])
          end
        end
      end
      affected_tags = affected_tags.uniq.sort
    %>
    <div class="event-banner event-banner--<%= event.rarity %> <%= 'event-banner--unseen' if is_unseen %>">
      <div class="event-banner__container">
        <div class="event-banner__graphic">
          <%= render partial: svg_partial_path rescue '' %>
        </div>
        <div class="event-banner__content">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <h3 class="event-banner__title" style="margin: 0;"><%= event.name %></h3>
            <% if affected_tags.any? %>
              <details class="tags-toggle tags-toggle--inline">
                <summary class="tags-toggle__summary">…</summary>
                <div class="tags">
                  <% affected_tags.each do |tag| %>
                    <span class="tag tag--<%= tag.gsub('_', '-') %>"><%= tag.gsub('_', ' ') %></span>
                  <% end %>
                </div>
              </details>
            <% end %>
          </div>
          <p class="event-banner__description"><%= event.description %></p>
          <div class="event-banner__meta">
            <%= event.event_type&.titleize || 'Event' %> •
            Severity: <%= event.severity %>/5 •
            <%= game_event.days_remaining %> <%= 'day'.pluralize(game_event.days_remaining) %> remaining
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="Page__Content">
    <%= turbo_frame_tag "flash_messages" %>

    <% if @location_resources.any? %>
      <table class="Table">
        <thead>
          <tr>
            <th>Resource</th>
            <th class="Table__Cell--right">Market Price</th>
            <th class="Table__Cell--right">Your Position</th>
            <th class="Table__Cell--right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @location_resources.each do |location_resource| %>
            <%= render partial: "marketplace/resource_row",
                       locals: {
                         location_resource: location_resource,
                         game: @game,
                         inventory_by_resource: @inventory_by_resource
                       } %>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="Alert Alert--info">
        <p>No resources available at this location. Travel to discover new markets!</p>
      </div>
    <% end %>
  </div>
</div>
