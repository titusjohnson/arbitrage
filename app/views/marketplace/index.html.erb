<div class="Page">
  <div class="Page__Header">
    <h1 class="Page__Title"><%= @location.name %> Marketplace</h1>
    <% if @location.description.present? %>
      <p class="Page__Subtitle"><%= @location.description %></p>
    <% end %>
  </div>

  <% @active_events = @game.game_events.active.includes(:event) %>
  <% @active_events.each do |game_event| %>
    <% event = game_event.event %>
    <% is_unseen = !game_event.seen? %>
    <% game_event.update(seen: true) if is_unseen %>
    <%
      # Create sanitized filename from event name
      svg_filename = event.name.downcase.gsub(/[^a-z0-9]+/, '_').gsub(/^_|_$/, '')
      svg_partial_path = "events/_graphics/#{svg_filename}"

      # Extract affected tags from resource_effects
      affected_tags = []
      if event.resource_effects.present?
        if event.resource_effects['price_modifiers']
          event.resource_effects['price_modifiers'].each do |mod|
            affected_tags.concat(mod['tags'] || [])
          end
        end
        if event.resource_effects['availability_modifiers']
          event.resource_effects['availability_modifiers'].each do |mod|
            affected_tags.concat(mod['tags'] || [])
          end
        end
      end
      affected_tags = affected_tags.uniq.sort
    %>
    <div class="event-banner event-banner--<%= event.rarity %> <%= 'event-banner--unseen' if is_unseen %>">
      <div class="event-banner__container">
        <div class="event-banner__graphic">
          <%= render partial: svg_partial_path rescue '' %>
        </div>
        <div class="event-banner__content">
          <h3 class="event-banner__title"><%= event.name %></h3>
          <p class="event-banner__description"><%= event.description %></p>
          <% if affected_tags.any? %>
            <div class="tags" style="margin: 0.5rem 0;">
              <% affected_tags.each do |tag| %>
                <span class="tag tag--<%= tag.gsub('_', '-') %>"><%= tag.gsub('_', ' ') %></span>
              <% end %>
            </div>
          <% end %>
          <div class="event-banner__meta">
            <%= event.event_type&.titleize || 'Event' %> •
            Severity: <%= event.severity %>/5 •
            <%= game_event.days_remaining %> <%= 'day'.pluralize(game_event.days_remaining) %> remaining
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="Page__Content">
    <% if @location_resources.any? %>
      <table class="Table">
        <thead>
          <tr>
            <th>Resource</th>
            <th class="Table__Cell--right">Market Price</th>
            <th class="Table__Cell--right">Your Position</th>
            <th class="Table__Cell--right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @location_resources.each do |location_resource| %>
            <%
              resource = location_resource.resource
              inventory_items = @inventory_by_resource[resource.id] || []
              has_inventory = inventory_items.any?

              if has_inventory
                # Calculate average purchase price and total quantity
                total_quantity = inventory_items.sum(&:quantity)
                total_cost = inventory_items.sum { |item| item.purchase_price * item.quantity }
                avg_purchase_price = total_cost / total_quantity

                # Calculate profit/loss
                current_value = location_resource.current_price * total_quantity
                total_paid = total_cost
                profit_loss = current_value - total_paid
                profit_loss_pct = ((profit_loss / total_paid) * 100).round(1)
                is_profit = profit_loss >= 0
              end
            %>
            <tr>
              <td>
                <strong><%= resource.name %></strong>
                <% if resource.description.present? %>
                  <br>
                  <small class="Text--muted"><%= resource.description %></small>
                <% end %>
                <% if resource.tags.any? %>
                  <div class="tags">
                    <% resource.tags.each do |tag| %>
                      <span class="tag tag--<%= tag.name.gsub('_', '-') %>"><%= tag.name.gsub('_', ' ') %></span>
                    <% end %>
                  </div>
                <% end %>
              </td>
              <td class="Table__Cell--right">
                <strong>$<%= number_with_delimiter(location_resource.current_price, delimiter: ',') %></strong>
                <br>
                <small class="Text--muted">
                  Size: <%= resource.inventory_size %>
                  | <%= resource.rarity.titleize %>
                  <br>
                  Stock: <%= location_resource.available_quantity %>
                </small>
              </td>
              <td class="Table__Cell--right">
                <% if has_inventory %>
                  <strong><%= total_quantity %> units</strong>
                  <br>
                  <small class="Text--muted">
                    Avg: $<%= number_with_delimiter(avg_purchase_price.round(2), delimiter: ',') %>
                  </small>
                  <br>
                  <small class="<%= is_profit ? 'Text--success' : 'Text--danger' %>">
                    <%= is_profit ? '+' : '' %>$<%= number_with_delimiter(profit_loss.round(2), delimiter: ',') %>
                    (<%= is_profit ? '+' : '' %><%= profit_loss_pct %>%)
                  </small>
                <% else %>
                  <small class="Text--muted">—</small>
                <% end %>
              </td>
              <td class="Table__Cell--right">
                <%= form_with url: marketplace_buy_path, method: :post, style: "display: inline;" do |form| %>
                  <%= form.hidden_field :location_resource_id, value: location_resource.id %>
                  <%= form.hidden_field :quantity, value: 1 %>
                  <%= form.submit "Buy", class: "button button--primary" %>
                <% end %>
                <% if has_inventory %>
                  <%= form_with url: marketplace_sell_path, method: :post, style: "display: inline;" do |form| %>
                    <%= form.hidden_field :location_resource_id, value: location_resource.id %>
                    <%= form.hidden_field :quantity, value: 1 %>
                    <%= form.submit "Sell", class: "button" %>
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="Alert Alert--info">
        <p>No resources available at this location. Travel to discover new markets!</p>
      </div>
    <% end %>
  </div>
</div>
