<div class="Page">
  <div class="Page__Header">
    <h1 class="Page__Title"><%= @location.name %> Marketplace</h1>
    <% if @location.description.present? %>
      <p class="Page__Subtitle"><%= @location.description %></p>
    <% end %>
  </div>

  <div class="Page__Content">
    <% if @location_resources.any? %>
      <table class="Table">
        <thead>
          <tr>
            <th>Resource</th>
            <th class="Table__Cell--right">Market Price</th>
            <th class="Table__Cell--right">Your Position</th>
            <th class="Table__Cell--right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @location_resources.each do |location_resource| %>
            <%
              resource = location_resource.resource
              inventory_items = @inventory_by_resource[resource.id] || []
              has_inventory = inventory_items.any?

              if has_inventory
                # Calculate average purchase price and total quantity
                total_quantity = inventory_items.sum(&:quantity)
                total_cost = inventory_items.sum { |item| item.purchase_price * item.quantity }
                avg_purchase_price = total_cost / total_quantity

                # Calculate profit/loss
                current_value = location_resource.current_price * total_quantity
                total_paid = total_cost
                profit_loss = current_value - total_paid
                profit_loss_pct = ((profit_loss / total_paid) * 100).round(1)
                is_profit = profit_loss >= 0
              end
            %>
            <tr>
              <td>
                <strong><%= resource.name %></strong>
                <% if resource.description.present? %>
                  <br>
                  <small class="Text--muted"><%= resource.description %></small>
                <% end %>
              </td>
              <td class="Table__Cell--right">
                <strong>$<%= number_with_delimiter(location_resource.current_price, delimiter: ',') %></strong>
                <br>
                <small class="Text--muted">
                  Size: <%= resource.inventory_size %>
                  | <%= resource.rarity.titleize %>
                  <br>
                  Stock: <%= location_resource.available_quantity %>
                </small>
              </td>
              <td class="Table__Cell--right">
                <% if has_inventory %>
                  <strong><%= total_quantity %> units</strong>
                  <br>
                  <small class="Text--muted">
                    Avg: $<%= number_with_delimiter(avg_purchase_price.round(2), delimiter: ',') %>
                  </small>
                  <br>
                  <small class="<%= is_profit ? 'Text--success' : 'Text--danger' %>">
                    <%= is_profit ? '+' : '' %>$<%= number_with_delimiter(profit_loss.round(2), delimiter: ',') %>
                    (<%= is_profit ? '+' : '' %><%= profit_loss_pct %>%)
                  </small>
                <% else %>
                  <small class="Text--muted">â€”</small>
                <% end %>
              </td>
              <td class="Table__Cell--right">
                <%= form_with url: marketplace_buy_path, method: :post, style: "display: inline;" do |form| %>
                  <%= form.hidden_field :resource_id, value: resource.id %>
                  <%= form.hidden_field :location_resource_id, value: location_resource.id %>
                  <%= form.hidden_field :quantity, value: 1 %>
                  <%= form.hidden_field :price_per_unit, value: location_resource.current_price %>
                  <%= form.submit "Buy", class: "button button--primary" %>
                <% end %>
                <% if has_inventory %>
                  <%= form_with url: marketplace_sell_path, method: :post, style: "display: inline;" do |form| %>
                    <%= form.hidden_field :resource_id, value: resource.id %>
                    <%= form.hidden_field :quantity, value: 1 %>
                    <%= form.hidden_field :price_per_unit, value: location_resource.current_price %>
                    <%= form.submit "Sell", class: "button" %>
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="Alert Alert--info">
        <p>No resources available at this location. Travel to discover new markets!</p>
      </div>
    <% end %>
  </div>
</div>
